<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ROI - Flotte Auto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #111827; --card: #1f2937; --text: #e5e7eb; --muted:#9ca3af; --primary:#2563eb; --primary-d:#1e40af;
      --bar: #3b82f6; --bar2:#10b981;
    }
    .light {
      --bg:#f3f4f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-d:#1e40af;
      --bar:#2563eb; --bar2:#059669;
    }
    body { background-color: var(--bg); color: var(--text); }
    .card { background-color: var(--card); border-radius: .75rem; padding: 1.25rem; box-shadow: 0 6px 24px rgba(0,0,0,.15); }
    .btn { background-color: var(--primary); color: white; padding: .5rem 1rem; border-radius: .5rem; }
    .btn:hover { background-color: var(--primary-d); }
    .btn-ghost { background: rgba(255,255,255,.08); color: var(--text); padding: .5rem .8rem; border-radius: .5rem; }
    input, select {
      background-color: transparent; color: var(--text); border: 1px solid rgba(255,255,255,.2);
      border-radius: .375rem; padding: .5rem; width: 100%;
    }
    label { color: var(--muted); font-size: .9rem; }
    .toggle { display:flex; align-items:center; gap:.5rem; cursor:pointer; }
    .toggle input { width: 2.5rem; height: 1.3rem; appearance: none; background: rgba(255,255,255,.2); border-radius: 999px; position: relative; outline: none; }
    .toggle input:checked { background: var(--primary); }
    .toggle input:before { content:""; position:absolute; top:2px; left:2px; width:1rem; height:1rem; background:#fff; border-radius:999px; transition: all .2s; }
    .toggle input:checked:before { transform: translateX(1.2rem); }
    .tag { font-size:.75rem; padding:.2rem .5rem; border-radius:999px; background: rgba(255,255,255,.1); }
    .row { display:grid; grid-template-columns: repeat(1, minmax(0,1fr)); gap: .75rem; }
    @media (min-width: 768px){ .row-2 { grid-template-columns: repeat(2, minmax(0,1fr)); } .row-3{ grid-template-columns: repeat(3, minmax(0,1fr)); } .row-4{ grid-template-columns: repeat(4, minmax(0,1fr)); } }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid rgba(255,255,255,.08); padding:.5rem .6rem; }
    th { color: var(--muted); text-align: left; }
    .pill { font-size:.75rem; font-weight:700; padding:.2rem .5rem; border-radius:999px; }
  </style>
</head>
<body>
  <header class="mb-6">
    <div class="flex items-center justify-between gap-4">
      <h1 class="text-2xl font-bold">üìä Dashboard ROI ‚Äì Flotte Auto</h1>
      <div class="flex items-center gap-2">
        <!-- Theme toggle -->
        <label class="toggle" title="Basculer th√®me clair/sombre">
          <span>Th√®me clair</span>
          <input type="checkbox" id="themeToggle"/>
        </label>
        <!-- Tesla toggle -->
        <label class="toggle" title="Activer/D√©sactiver Tesla">
          <span>Tesla</span>
          <input type="checkbox" id="teslaToggle"/>
        </label>
        <!-- Export / Import -->
        <button id="exportJson" class="btn-ghost">Export JSON</button>
        <label class="btn-ghost cursor-pointer">
          Import JSON <input id="importJson" type="file" accept="application/json" class="hidden"/>
        </label>
        <button id="exportCsv" class="btn-ghost">Export CSV</button>
      </div>
    </div>

    <div class="mt-4 flex flex-wrap gap-2">
      <button class="btn" onclick="showTab('locations')">Locations r√©elles</button>
      <button class="btn" onclick="showTab('params')">Param√®tres</button>
      <button class="btn" onclick="showTab('previsions')">Pr√©visions & Tarifs</button>
      <button class="btn" onclick="showTab('suivi')">Suivi mensuel</button>
    </div>
  </header>

  <!-- LOCATIONS -->
  <section id="locations" class="card hidden">
    <h2 class="text-xl font-semibold mb-3">üìÖ Locations r√©elles</h2>
    <div class="row row-4">
      <div>
        <label>D√©but</label>
        <input type="date" id="date"/>
      </div>
      <div>
        <label>Jours</label>
        <input type="number" id="jours" min="1" value="1"/>
      </div>
      <div>
        <label>Prix proprio ‚Ç¨/jour</label>
        <input type="number" id="prixJour" min="0" step="0.1" value="30"/>
      </div>
      <div id="vehiculeWrap" class="hidden">
        <label>V√©hicule</label>
        <select id="vehicule">
          <option value="Clio">Clio</option>
          <option value="Tesla">Tesla</option>
        </select>
      </div>

      <div>
        <label>Km totaux (optionnel)</label>
        <input type="number" id="kms" min="0" step="1" placeholder="ex. 250"/>
      </div>
      <div>
        <label>Frais carburant & divers (‚Ç¨)</label>
        <input type="number" id="extras" min="0" step="0.1" value="0"/>
      </div>
      <div class="md:col-span-2">
        <label>Notes</label>
        <input type="text" id="notes" placeholder="Ex. week-end, pro, remise‚Ä¶"/>
      </div>
    </div>
    <div class="mt-3 flex gap-2">
      <button class="btn" onclick="saveLocation()">Enregistrer</button>
      <select id="filterVehicule" class="w-auto">
        <option value="ALL">Tous v√©hicules</option>
        <option value="Clio">Clio</option>
        <option value="Tesla">Tesla</option>
      </select>
      <input type="month" id="filterMonth" class="w-auto"/>
      <button class="btn-ghost" onclick="clearFilters()">Effacer filtres</button>
    </div>

    <div class="mt-4 overflow-x-auto">
      <table>
        <thead>
          <tr>
            <th>Date</th><th>Jours</th><th>‚Ç¨/j</th><th>Km</th><th>Extras</th><th>V√©hicule</th><th>Net loc</th><th>Notes</th><th></th>
          </tr>
        </thead>
        <tbody id="locTable"></tbody>
      </table>
    </div>
    <p class="text-sm mt-2" style="color:var(--muted)">Net location = (prix √ó jours √ó (1‚Äìcommission)) ‚àí usure(km√ó‚Ç¨/km) ‚àí extras.</p>
  </section>

  <!-- PARAMS -->
  <section id="params" class="card hidden">
    <h2 class="text-xl font-semibold mb-3">‚öôÔ∏è Param√®tres</h2>
    <div class="row row-3">
      <div>
        <label>Commission plateforme (%)</label>
        <input type="number" id="commission" min="0" step="0.1" value="10"/>
      </div>
      <div>
        <label>Usure ‚Ç¨/km</label>
        <input type="number" id="wearPerKm" min="0" step="0.01" value="0.12"/>
      </div>
      <div>
        <label>Km inclus / jour</label>
        <input type="number" id="kmInclus" min="0" step="1" value="100"/>
      </div>
    </div>

    <div class="mt-4 grid md:grid-cols-2 gap-4">
      <div class="card" style="background: transparent; border:1px solid rgba(255,255,255,.12);">
        <h3 class="font-semibold mb-2">Clio ‚Äì frais fixes mensuels</h3>
        <div class="row row-3">
          <div><label>Assurance (‚Ç¨)</label><input type="number" id="clioAss" value="54"/></div>
          <div><label>Connect (‚Ç¨)</label><input type="number" id="clioConn" value="25"/></div>
          <div><label>Entretien (‚Ç¨)</label><input type="number" id="clioEnt" value="45"/></div>
        </div>
      </div>
      <div class="card" id="teslaParamsCard" style="background: transparent; border:1px solid rgba(255,255,255,.12); display:none;">
        <h3 class="font-semibold mb-2">Tesla ‚Äì frais fixes mensuels</h3>
        <div class="row row-3">
          <div><label>Assurance (‚Ç¨)</label><input type="number" id="teslaAss" value="115"/></div>
          <div><label>Connect (‚Ç¨)</label><input type="number" id="teslaConn" value="0"/></div>
          <div><label>Entretien (‚Ç¨)</label><input type="number" id="teslaEnt" value="30"/></div>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <button class="btn" onclick="saveParams()">üíæ Sauvegarder</button>
      <span id="savedTag" class="tag hidden">‚úîÔ∏è Sauvegard√©</span>
    </div>
  </section>

  <!-- PREVISIONS -->
  <section id="previsions" class="card hidden">
    <h2 class="text-xl font-semibold mb-3">üìà Pr√©visions & Tarifs</h2>
    <div class="row row-4">
      <div><label>Jours lou√©s / mois</label><input type="number" id="simDays" value="12"/></div>
      <div><label>Prix proprio ‚Ç¨/j</label><input type="number" id="simPrice" value="30" step="0.1"/></div>
      <div><label>Km/j (moy.)</label><input type="number" id="simKmDay" value="100"/></div>
      <div><label>Saisonnalit√© (%)</label><input type="number" id="simSeason" value="100"/></div>
    </div>
    <div class="mt-3 flex gap-2">
      <select id="simVehicule" class="w-auto">
        <option value="Clio">Clio</option>
        <option value="Tesla">Tesla</option>
      </select>
      <button class="btn" onclick="runSim()">Calculer</button>
    </div>
    <div id="simOut" class="mt-4"></div>

    <div class="mt-6">
      <h3 class="font-semibold mb-2">Pr√©visions 12 mois (saisonnalit√© simple)</h3>
      <canvas id="simChart" height="140"></canvas>
    </div>
  </section>

  <!-- SUIVI -->
  <section id="suivi" class="card hidden">
    <h2 class="text-xl font-semibold mb-3">üìä Suivi mensuel</h2>
    <div class="flex flex-wrap items-center gap-2 mb-3">
      <select id="suiviVehicule" class="w-auto">
        <option value="ALL">Tous v√©hicules</option>
        <option value="Clio">Clio</option>
        <option value="Tesla">Tesla</option>
      </select>
      <input type="month" id="suiviMonth" class="w-auto" />
    </div>
    <div class="grid md:grid-cols-2 gap-4">
      <div><canvas id="chartNet" height="150"></canvas></div>
      <div><canvas id="chartCumul" height="150"></canvas></div>
    </div>
    <p id="monthSummary" class="mt-3 text-sm" style="color:var(--muted)"></p>
  </section>

  <script>
    // ===== Storage & State =====
    const KEY='roi_dark_v1';
    const data = JSON.parse(localStorage.getItem(KEY) || '{}');
    const theme = data.theme || 'dark';            // 'dark' | 'light'
    let teslaOn   = data.teslaOn ?? false;
    let settings  = data.settings || {
      commission:10, wearPerKm:0.12, kmInclus:100,
      clio:{ass:54, conn:25, ent:45},
      tesla:{ass:115, conn:0, ent:30}
    };
    let locations = data.locations || []; // {id, date, jours, prixJour, kms, extras, notes, vehicule}

    // ===== Theme init =====
    function applyTheme(){
      if(themeToggle.checked){ // light ON
        document.documentElement.classList.add('light');
      } else {
        document.documentElement.classList.remove('light');
      }
    }
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.checked = (theme === 'light');
    applyTheme();
    themeToggle.addEventListener('change', ()=>{
      data.theme = themeToggle.checked ? 'light' : 'dark';
      localStorage.setItem(KEY, JSON.stringify({...data, theme: data.theme}));
      applyTheme();
    });

    // ===== Tesla toggle init =====
    const teslaToggle = document.getElementById('teslaToggle');
    teslaToggle.checked = !!teslaOn;
    function applyTeslaUI(){
      document.getElementById('vehiculeWrap').style.display = teslaToggle.checked ? 'block' : 'none';
      document.getElementById('teslaParamsCard').style.display = teslaToggle.checked ? 'block' : 'none';
      document.getElementById('simVehicule').style.display = teslaToggle.checked ? 'inline-block' : 'none';
      document.querySelectorAll('#filterVehicule, #suiviVehicule').forEach(sel=>{
        sel.querySelectorAll('option[value="Tesla"]').forEach(o=> o.disabled = !teslaToggle.checked);
      });
    }
    applyTeslaUI();
    teslaToggle.addEventListener('change', ()=>{
      teslaOn = teslaToggle.checked;
      data.teslaOn = teslaOn;
      localStorage.setItem(KEY, JSON.stringify({...data, teslaOn}));
      applyTeslaUI();
      renderTable(); renderCharts();
    });

    // ===== Tabs =====
    function showTab(id){
      document.querySelectorAll('section.card').forEach(s=> s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if(id==='suivi'){ renderCharts(); }
    }
    showTab('locations'); // default

    // ===== Helpers =====
    const $ = id => document.getElementById(id);
    const euro = n => `${(n||0).toFixed(2)}‚Ç¨`;
    const monthKey = d => d?.slice(0,7);
    function saveAll(){
      localStorage.setItem(KEY, JSON.stringify({theme: themeToggle.checked?'light':'dark', teslaOn, settings, locations}));
    }

    // ===== Locations CRUD =====
    function saveLocation(){
      const date = $('date').value;
      if(!date) return alert('Choisis une date');
      const loc = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
        date,
        jours: Number($('jours').value||1),
        prixJour: Number($('prixJour').value||0),
        kms: $('kms').value ? Number($('kms').value) : 0,
        extras: Number($('extras').value||0),
        notes: $('notes').value||'',
        vehicule: teslaToggle.checked ? $('vehicule').value : 'Clio'
      };
      locations.push(loc);
      saveAll();
      clearLocForm();
      renderTable();
    }
    function clearLocForm(){
      ['date','jours','prixJour','kms','extras','notes'].forEach(id=>{
        if(id==='jours'){$(id).value=1;} else if(id==='prixJour'){$(id).value=30;} else { $(id).value=''; }
      });
      if(teslaToggle.checked) $('vehicule').value='Clio';
    }
    function removeLoc(id){
      locations = locations.filter(l=> l.id!==id);
      saveAll(); renderTable(); renderCharts();
    }

    function netLocation(loc){
      const com = (settings.commission||0)/100;
      const gross = loc.prixJour * (loc.jours||1);
      const after = gross * (1 - com);
      const wear  = (loc.kms||0) * (settings.wearPerKm||0);
      return after - wear - (loc.extras||0);
    }

    function clearFilters(){
      $('filterMonth').value = '';
      $('filterVehicule').value = 'ALL';
      renderTable();
    }

    function renderTable(){
      const tbody = $('locTable'); tbody.innerHTML='';
      const m = $('filterMonth').value;
      const vf = $('filterVehicule').value;

      // sort desc by date
      const arr = locations.slice().sort((a,b)=> new Date(b.date)-new Date(a.date))
        .filter(l=> (!m || monthKey(l.date)===m) && (vf==='ALL' || l.vehicule===vf));

      for(const l of arr){
        const tr = document.createElement('tr');
        const net = netLocation(l);
        tr.innerHTML = `
          <td>${l.date}</td>
          <td>${l.jours||1}</td>
          <td>${l.prixJour.toFixed(2)}</td>
          <td>${l.kms||'-'}</td>
          <td>${(l.extras||0).toFixed(2)}</td>
          <td>${l.vehicule||'Clio'}</td>
          <td><span class="pill" style="background:${net>=0?'rgba(16,185,129,.2)':'rgba(239,68,68,.2)'};color:${net>=0?'#10b981':'#ef4444'}">${net.toFixed(2)}‚Ç¨</span></td>
          <td title="${l.notes||''}" style="max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${l.notes||''}</td>
          <td><button class="btn-ghost" onclick="removeLoc('${l.id}')">üóëÔ∏è</button></td>
        `;
        tbody.appendChild(tr);
      }
    }
    $('filterMonth').addEventListener('change', renderTable);
    $('filterVehicule').addEventListener('change', renderTable);
    renderTable();

    // ===== Params =====
    function loadParamsIntoUI(){
      $('commission').value = settings.commission;
      $('wearPerKm').value  = settings.wearPerKm;
      $('kmInclus').value   = settings.kmInclus;
      $('clioAss').value = settings.clio.ass;
      $('clioConn').value = settings.clio.conn;
      $('clioEnt').value = settings.clio.ent;
      $('teslaAss').value = settings.tesla.ass;
      $('teslaConn').value = settings.tesla.conn;
      $('teslaEnt').value = settings.tesla.ent;
    }
    function saveParams(){
      settings.commission = Number($('commission').value||0);
      settings.wearPerKm  = Number($('wearPerKm').value||0);
      settings.kmInclus   = Number($('kmInclus').value||0);
      settings.clio = {
        ass: Number($('clioAss').value||0),
        conn: Number($('clioConn').value||0),
        ent: Number($('clioEnt').value||0),
      };
      settings.tesla = {
        ass: Number($('teslaAss').value||0),
        conn: Number($('teslaConn').value||0),
        ent: Number($('teslaEnt').value||0),
      };
      saveAll();
      $('savedTag').classList.remove('hidden');
      setTimeout(()=>$('savedTag').classList.add('hidden'), 1200);
      renderCharts();
    }
    loadParamsIntoUI();

    // ===== Pr√©visions =====
    let simChart;
    function runSim(){
      const days   = Number($('simDays').value||0);
      const price  = Number($('simPrice').value||0);
      const kmday  = Number($('simKmDay').value||0);
      const season = Number($('simSeason').value||100)/100;
      const veh    = (teslaToggle.checked ? $('simVehicule').value : 'Clio');

      const com = (settings.commission||0)/100;
      const monthlyGross = price*days;
      const after = monthlyGross*(1-com);
      const wear  = (kmday*days)*(settings.wearPerKm||0);

      const fix = (veh==='Tesla' ? (settings.tesla.ass+settings.tesla.conn+settings.tesla.ent)
                                  : (settings.clio.ass+settings.clio.conn+settings.clio.ent));
      const net = (after - wear - fix)*season;

      $('simOut').innerHTML = `
        <div class="grid md:grid-cols-4 gap-3">
          <div class="card"><div class="text-sm" style="color:var(--muted)">Net avant frais fixes</div><div class="text-xl font-semibold">${euro(after-wear)}</div></div>
          <div class="card"><div class="text-sm" style="color:var(--muted)">Frais fixes (${veh})</div><div class="text-xl font-semibold">-${euro(fix)}</div></div>
          <div class="card"><div class="text-sm" style="color:var(--muted)">R√©sultat net (apr√®s saison.)</div><div class="text-xl font-semibold">${euro(net)}</div></div>
          <div class="card"><div class="text-sm" style="color:var(--muted)">Point mort (jours)</div><div class="text-xl font-semibold">${pointMort(price, kmday, fix)}</div></div>
        </div>
      `;

      const months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
      const seasonCurve=[0.85,0.8,0.9,1.0,1.05,1.15,1.25,1.2,1.0,0.95,0.85,0.9];
      const base = (after - wear - fix);
      const data = months.map((_,i)=> base * seasonCurve[i]);

      if(simChart){ simChart.destroy(); }
      const ctx = document.getElementById('simChart').getContext('2d');
      simChart = new Chart(ctx,{
        type:'bar',
        data:{ labels:months, datasets:[{ label:'Pr√©vision nette mensuelle (‚Ç¨)', data,
          backgroundColor: data.map(v=> v>=0 ? 'rgba(59,130,246,.8)' : 'rgba(239,68,68,.8)') }]},
        options:{ plugins:{ legend:{display:false}, tooltip:{callbacks:{label:c=>`${c.parsed.y.toFixed(2)} ‚Ç¨`}}}, scales:{ y:{ beginAtZero:true } } }
      });
    }
    function pointMort(price, kmday, fix){
      const com = (settings.commission||0)/100;
      const netPerDay = price*(1-com) - (kmday*(settings.wearPerKm||0));
      if(netPerDay<=0) return '‚àû';
      return (fix/netPerDay).toFixed(1);
    }

    // ===== Suivi / Charts =====
    let chartNet, chartCumul;
    function renderCharts(){
      const vehF = $('suiviVehicule').value;
      const mSel = $('suiviMonth').value;
      const filtered = locations.filter(l => (vehF==='ALL' || l.vehicule===vehF) && (!mSel || monthKey(l.date)===mSel));

      // Group by month
      const monthsMap = {};
      for(const l of filtered){
        const mk = monthKey(l.date);
        monthsMap[mk] = monthsMap[mk] || [];
        monthsMap[mk].push(l);
      }
      const months = Object.keys(monthsMap).sort();
      const monthlyNetBeforeFix = months.map(m => monthsMap[m].reduce((s,l)=> s + netLocation(l), 0));

      // Monthly fix by vehicle selection:
      const monthlyFix = months.map(m=>{
        // If filter = specific veh, use that vehicle's fix; otherwise, sum both vehicles fix
        const useVehicles = (vehF==='ALL' ? ['Clio','Tesla'].filter(v=> teslaOn ? true : v==='Clio') : [vehF]);
        return useVehicles.reduce((sum,v)=>{
          const f = (v==='Tesla' ? (settings.tesla.ass+settings.tesla.conn+settings.tesla.ent)
                                 : (settings.clio.ass+settings.clio.conn+settings.clio.ent));
          return sum + f;
        }, 0);
      });

      const monthlyAfter = monthlyNetBeforeFix.map((v,i)=> v - monthlyFix[i]);

      // Month summary (selected or latest)
      const currentM = $('suiviMonth').value || months[months.length-1];
      if(currentM){
        const list = monthsMap[currentM] || [];
        const before = list.reduce((s,l)=> s + netLocation(l), 0);
        // Fix: if ALL vehicles selected, sum both monthly fixes; else single
        const fix = (vehF==='ALL'
                      ? (teslaOn ? (settings.clio.ass+settings.clio.conn+settings.clio.ent + settings.tesla.ass+settings.tesla.conn+settings.tesla.ent)
                                 : (settings.clio.ass+settings.clio.conn+settings.clio.ent))
                      : (vehF==='Tesla' ? (settings.tesla.ass+settings.tesla.conn+settings.tesla.ent)
                                        : (settings.clio.ass+settings.clio.conn+settings.clio.ent)));
        const after = before - fix;
        $('monthSummary').textContent = `${currentM} ¬∑ Net avant frais fixes: ${euro(before)} ¬∑ Frais fixes: -${euro(fix)} ¬∑ R√©sultat net: ${euro(after)} (${after>=0?'‚úÖ positif':'‚ùå n√©gatif'})`;
      } else {
        $('monthSummary').textContent = 'Aucune donn√©e pour le moment.';
      }

      if(chartNet){ chartNet.destroy(); }
      if(chartCumul){ chartCumul.destroy(); }

      const ctx1 = document.getElementById('chartNet').getContext('2d');
      chartNet = new Chart(ctx1, {
        type:'bar',
        data:{ labels:months, datasets:[{ label:'Net apr√®s frais fixes (‚Ç¨)', data:monthlyAfter,
          backgroundColor: monthlyAfter.map(v=> v>=0 ? 'rgba(59,130,246,.8)' : 'rgba(239,68,68,.8)') }]},
        options:{ plugins:{ legend:{display:false}, tooltip:{callbacks:{label:c=>`${c.parsed.y.toFixed(2)} ‚Ç¨`}}}, scales:{ y:{ beginAtZero:true } } }
      });

      const cum=[]; let acc=0; for(const v of monthlyAfter){ acc+=v; cum.push(acc); }
      const ctx2 = document.getElementById('chartCumul').getContext('2d');
      chartCumul = new Chart(ctx2, {
        type:'line',
        data:{ labels:months, datasets:[{ label:'Cumul annuel (‚Ç¨)', data:cum, fill:false, borderColor:'rgba(59,130,246,.9)', tension:.25, pointRadius:3 }]},
        options:{ plugins:{ legend:{display:false} } }
      });
    }
    $('suiviVehicule').addEventListener('change', renderCharts);
    $('suiviMonth').addEventListener('change', renderCharts);

    // ===== Export/Import =====
    $('exportJson').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify({theme: themeToggle.checked?'light':'dark', teslaOn, settings, locations}, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `roi-data-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 0);
    });
    $('importJson').addEventListener('change', e=>{
      const f = e.target.files?.[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const d = JSON.parse(r.result);
          if(d.theme) { data.theme=d.theme; themeToggle.checked=(d.theme==='light'); applyTheme(); }
          if(typeof d.teslaOn==='boolean'){ teslaOn=d.teslaOn; teslaToggle.checked=teslaOn; }
          if(d.settings) settings = d.settings;
          if(Array.isArray(d.locations)) locations = d.locations;
          saveAll(); loadParamsIntoUI(); applyTeslaUI(); renderTable(); renderCharts();
          alert('Import r√©ussi ‚úÖ');
        }catch(e){ alert('Fichier invalide ‚ùå'); }
      };
      r.readAsText(f);
    });

    $('exportCsv').addEventListener('click', ()=>{
      const rows = [['id','date','jours','prixJour','kms','extras','vehicule','net','notes']];
      locations.forEach(l=> rows.push([
        l.id, l.date, l.jours, l.prixJour, l.kms, l.extras, l.vehicule||'Clio', netLocation(l).toFixed(2), (l.notes||'').replace(/"/g,'""')
      ]));
      const csv = rows.map(r=> r.map(x=> `"${String(x)}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'locations.csv';
      a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 0);
    });

    // First render
    renderCharts();
  </script>
</body>
</html>
