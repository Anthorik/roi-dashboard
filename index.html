<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ROI - Flotte Auto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg1:#0b0d10; --bg2:#111418; --card:rgba(22,26,32,.72); --text:#e7e9ee; --muted:#a4acb9;
      --border:rgba(255,255,255,.08); --ring:#7dd3fc;
      --primary:#4f46e5; --primary-d:#4338ca;
      --pos:#16a34a; --neg:#ef4444;
    }
    .light{
      --bg1:#f7f8fb; --bg2:#eef1f6; --card:rgba(255,255,255,.9); --text:#0f172a; --muted:#5b6576;
      --border:rgba(15,23,42,.12); --ring:#0ea5e9;
      --primary:#2563eb; --primary-d:#1e40af;
      --pos:#16a34a; --neg:#ef4444;
    }
    body{
      min-height:100vh;
      background:
        radial-gradient(1000px 600px at 15% -10%, rgba(79,70,229,.14), transparent 60%),
        radial-gradient(900px 560px at 100% 10%, rgba(14,165,233,.12), transparent 55%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--text);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:1rem; padding:1.1rem; backdrop-filter: blur(8px); }
    .btn{ background:linear-gradient(180deg,var(--primary),var(--primary-d)); color:#fff; padding:.55rem .95rem; border-radius:.7rem; font-weight:700; }
    .btn-ghost{ background:transparent; border:1px solid var(--border); border-radius:.7rem; padding:.5rem .8rem; color:var(--text); }
    input,select{ background:rgba(255,255,255,.03); color:var(--text); border:1px solid var(--border); border-radius:.6rem; padding:.55rem .65rem; width:100%; }
    label{ color:var(--muted); font-size:.9rem; }
    table{ width:100%; border-collapse:collapse; } th,td{ border-bottom:1px solid var(--border); padding:.55rem .6rem; } th{ color:var(--muted); text-align:left; }
    .pill{ font-size:.75rem; font-weight:800; padding:.2rem .55rem; border-radius:999px; }
    .grid-2{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; }
    .grid-3{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; }
    .grid-4{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; }
    @media(min-width:768px){ .grid-2{ grid-template-columns:repeat(2,1fr); } .grid-3{ grid-template-columns:repeat(3,1fr); } .grid-4{ grid-template-columns:repeat(4,1fr); } }
    .toggle{ display:flex; align-items:center; gap:.5rem; cursor:pointer; }
    .toggle input{ width:2.6rem; height:1.35rem; appearance:none; border:1px solid var(--border); border-radius:999px; position:relative; background:rgba(255,255,255,.08); }
    .toggle input:checked{ background:linear-gradient(180deg,var(--primary),var(--primary-d)); }
    .toggle input:before{ content:""; position:absolute; top:2px; left:2px; width:1.05rem; height:1.05rem; background:#fff; border-radius:999px; transition:all .18s ease; }
    .toggle input:checked:before{ transform:translateX(1.2rem); }
  </style>
</head>
<body>
  <header class="mb-6 max-w-7xl mx-auto px-4">
    <div class="flex items-center justify-between gap-4">
      <h1 class="text-2xl font-extrabold">üìä Dashboard ROI ‚Äì Flotte Auto</h1>
      <div class="flex flex-wrap items-center gap-2">
        <label class="toggle" title="Basculer th√®me clair/sombre"><span style="color:var(--muted)">Th√®me clair</span><input type="checkbox" id="themeToggle"/></label>
        <button id="exportJson" class="btn-ghost">Export JSON</button>
        <label class="btn-ghost cursor-pointer">Import JSON<input id="importJson" type="file" accept="application/json" class="hidden"/></label>
        <button id="exportCsv" class="btn-ghost">Export CSV</button>
      </div>
    </div>
    <div class="mt-4 flex flex-wrap gap-2">
      <button class="btn" onclick="showTab('locations')">Locations r√©elles</button>
      <button class="btn" onclick="showTab('vehicles')">V√©hicules</button>
      <button class="btn" onclick="showTab('params')">Param√®tres globaux</button>
      <button class="btn" onclick="showTab('previsions')">Pr√©visions & Tarifs</button>
      <button class="btn" onclick="showTab('suivi')">Suivi mensuel</button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 space-y-6">
    <!-- LOCATIONS -->
    <section id="locations" class="card hidden">
      <h2 class="text-xl font-semibold mb-3">üìÖ Locations r√©elles</h2>
      <div class="grid-4">
        <div><label>D√©but</label><input type="date" id="date"/></div>
        <div><label>Jours</label><input type="number" id="jours" min="1" value="1"/></div>
        <div><label>Prix proprio ‚Ç¨/jour</label><input type="number" id="prixJour" min="0" step="0.1" value="30"/></div>
        <div><label>V√©hicule</label><select id="vehicule"></select></div>
        <div><label>Km totaux (optionnel)</label><input type="number" id="kms" min="0" step="1" placeholder="ex. 250"/></div>
        <div><label>Frais divers (‚Ç¨)</label><input type="number" id="extras" min="0" step="0.1" value="0"/></div>
        <div><label>Ajustement carburant (+/‚àí ‚Ç¨)</label><input type="number" id="fuelAdj" step="0.1" value="0"/></div>
        <div class="md:col-span-2"><label>Notes</label><input type="text" id="notes" placeholder="Ex. week-end, pro, remise‚Ä¶"/></div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="saveBtn" class="btn" onclick="saveLocation()">Enregistrer</button>
        <button id="cancelEditBtn" class="btn-ghost hidden" onclick="cancelEdit()">Annuler</button>
        <select id="filterVehicule" class="w-auto"></select>
        <input type="month" id="filterMonth" class="w-auto"/>
        <button class="btn-ghost" onclick="clearFilters()">Effacer filtres</button>
      </div>
      <div class="mt-4 overflow-x-auto">
        <table>
          <thead><tr><th>Date</th><th>Jours</th><th>‚Ç¨/j</th><th>Km</th><th>Frais</th><th>Carburant ¬±</th><th>V√©hicule</th><th>Net loc</th><th>Notes</th><th>Actions</th></tr></thead>
          <tbody id="locTable"></tbody>
        </table>
      </div>
      <p class="text-sm mt-2" style="color:var(--muted)">Net location = (prix √ó jours √ó (1‚Äìcommission)) ‚àí usure(km√ó‚Ç¨/km) ‚àí frais divers + ajustement carburant.</p>
    </section>

    <!-- VEHICLES -->
    <section id="vehicles" class="card hidden">
      <h2 class="text-xl font-semibold mb-3">üöó V√©hicules</h2>
      <div class="mb-3 flex flex-wrap gap-2">
        <button class="btn" onclick="addVehicle()">+ Ajouter un v√©hicule</button>
      </div>
      <div id="vehiclesList" class="grid-2"></div>
    </section>

    <!-- PARAMS GLOBAUX -->
    <section id="params" class="card hidden">
      <h2 class="text-xl font-semibold mb-3">‚öôÔ∏è Param√®tres globaux</h2>
      <div class="grid-3">
        <div><label>Commission plateforme (%)</label><input type="number" id="commission" min="0" step="0.1" value="10"/></div>
        <div><label>Usure ‚Ç¨/km</label><input type="number" id="wearPerKm" min="0" step="0.01" value="0.12"/></div>
        <div><label>Km inclus / jour (info)</label><input type="number" id="kmInclus" min="0" step="1" value="100"/></div>
      </div>
      <div class="mt-4"><button class="btn" onclick="saveGlobals()">üíæ Sauvegarder</button><span id="savedTag" class="ml-3 text-sm" style="color:var(--muted); display:none;">‚úîÔ∏è Sauvegard√©</span></div>
    </section>

    <!-- PREVISIONS -->
    <section id="previsions" class="card hidden">
      <h2 class="text-xl font-semibold mb-3">üìà Pr√©visions & Tarifs</h2>
      <div class="grid-4">
        <div><label>V√©hicule</label><select id="simVehicule"></select></div>
        <div><label>Jours lou√©s / mois</label><input type="number" id="simDays" value="12" min="0"/></div>
        <div><label>Prix proprio ‚Ç¨/j</label><input type="number" id="simPrice" value="30" step="0.1" min="0"/></div>
        <div><label>Km/j (moy.)</label><input type="number" id="simKmDay" value="100" min="0"/></div>
      </div>
      <div class="grid-3 mt-3">
        <div><label>Commission (%)</label><input type="number" id="simCommission" step="0.1"/></div>
        <div><label>Usure ‚Ç¨/km</label><input type="number" id="simWear" step="0.01"/></div>
        <div><label>Saisonnalit√© de base (%)</label><input type="number" id="simSeasonBase" value="100"/></div>
      </div>
      <div class="mt-4"><button class="btn" onclick="runSim()">Calculer</button></div>
      <div id="simSummary" class="mt-4 grid-3"></div>
      <div class="mt-6">
        <h3 class="font-semibold mb-2">Pr√©vision mensuelle (12 mois)</h3>
        <canvas id="simChart" height="160"></canvas>
        <div class="mt-3 overflow-x-auto">
          <table>
            <thead><tr><th>Mois</th><th>CA brut</th><th>Apr√®s com</th><th>Usure</th><th>Frais fixes</th><th>Net</th></tr></thead>
            <tbody id="simTable"></tbody>
          </table>
        </div>
      </div>
      <div class="mt-6">
        <h3 class="font-semibold mb-2">Sensibilit√© rapide</h3>
        <div id="simWhatIf" class="grid-3"></div>
      </div>
    </section>

    <!-- SUIVI -->
    <section id="suivi" class="card hidden">
      <h2 class="text-xl font-semibold mb-3">üìä Suivi mensuel</h2>
      <div class="flex flex-wrap items-center gap-2 mb-3">
        <select id="suiviVehicule" class="w-auto"></select>
        <input type="month" id="suiviMonth" class="w-auto" />
      </div>
      <div class="grid-2">
        <div><canvas id="chartNet" height="150"></canvas></div>
        <div><canvas id="chartCumul" height="150"></canvas></div>
      </div>
      <div id="monthTop" class="mt-3 text-sm"></div>
      <div id="monthBreakdown" class="mt-2 grid-2"></div>
    </section>
  </main>

  <script>
    // ===== Storage & State =====
    const KEY='roi_multi_v3_resid';
    const data = JSON.parse(localStorage.getItem(KEY) || '{}');
    const theme = data.theme || 'dark';

    // Vehicles with residual value:
    // {id, name, active, costs:{ass,conn,ent,totalInvested,residual,amortMonths}}
    let vehicles = data.vehicles || [
      { id:'clio',  name:'Clio',  active:true, costs:{ass:56, conn:25, ent:45, totalInvested:11659, residual:0, amortMonths:60} },
      { id:'tesla', name:'Tesla', active:true, costs:{ass:115, conn:0,  ent:30, totalInvested:0,     residual:0, amortMonths:60} }
    ];
    // Migration depuis versions pr√©c√©dentes (sans residual)
    vehicles = vehicles.map(v=>{
      const c=v.costs||{};
      if(c.totalInvested===undefined){
        const total = (c.acqTotal||0) + (c.amort? (c.amort*(c.acqMonths||60)) : 0);
        return { ...v, costs:{ ass:c.ass||0, conn:c.conn||0, ent:c.ent||0, totalInvested: total||0, residual:0, amortMonths: c.acqMonths||60 } };
      }
      if(c.residual===undefined){ c.residual=0; }
      return v;
    });

    let globals = data.globals || { commission:10, wearPerKm:0.12, kmInclus:100 };
    // Locations: {id, date, jours, prixJour, kms, extras, fuelAdj, notes, vehiculeId}
    let locations = data.locations || [];
    let editId = null;

    // ===== Theme =====
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(){ themeToggle.checked ? document.documentElement.classList.add('light') : document.documentElement.classList.remove('light'); }
    themeToggle.checked=(theme==='light'); applyTheme();
    themeToggle.addEventListener('change', ()=>{ data.theme=themeToggle.checked?'light':'dark'; saveAll(); applyTheme(); });

    function saveAll(){ localStorage.setItem(KEY, JSON.stringify({theme: themeToggle.checked?'light':'dark', vehicles, globals, locations})); }
    const $=id=>document.getElementById(id);
    const euro=n=>`${(n||0).toFixed(2)}‚Ç¨`;
    const monthKey=d=> d?.slice(0,7);

    // ===== Vehicles logic =====
    function monthlyAmort(v){
      const c=v.costs||{};
      const months=Math.max(1, Number(c.amortMonths||0));
      let base = Number(c.totalInvested||0) - Number(c.residual||0);
      if(base < 0) base = 0;
      return base / months;
    }
    function fixedCostsMonthly(v){
      const c=v.costs||{};
      return (c.ass||0) + (c.conn||0) + (c.ent||0) + monthlyAmort(v);
    }
    function fixedCostsBreakdown(v){
      const c=v.costs||{};
      return {
        ass:c.ass||0, conn:c.conn||0, ent:c.ent||0,
        amort: monthlyAmort(v),
        base: Math.max(0, (c.totalInvested||0) - (c.residual||0)),
        months: Math.max(1, Number(c.amortMonths||0))
      };
    }
    function vehicleById(id){ return vehicles.find(v=> v.id===id); }

    // ===== Vehicles UI =====
    function renderVehiclesUI(){
      // Fill selects
      const active=vehicles.filter(v=> v.active);
      ['vehicule','filterVehicule','simVehicule','suiviVehicule'].forEach(id=>{
        const el=$(id); if(!el) return; el.innerHTML='';
        if(id==='filterVehicule' || id==='suiviVehicule'){
          const optAll=document.createElement('option'); optAll.value='ALL'; optAll.textContent='Tous v√©hicules'; el.appendChild(optAll);
        }
        active.forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=v.name; el.appendChild(o); });
      });

      // Cards
      const wrap=$('vehiclesList'); wrap.innerHTML='';
      vehicles.forEach(v=>{
        const c=v.costs||{}; const amort=monthlyAmort(v);
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`
          <div class="flex items-center justify-between">
            <input value="${v.name}" data-id="${v.id}" class="veh-name" style="max-width:240px"/>
            <label class="toggle"><span style="color:var(--muted)">Actif</span><input type="checkbox" ${v.active?'checked':''} data-id="${v.id}" class="veh-active"/></label>
          </div>
          <div class="grid-4 mt-3">
            <div><label>Assurance / mois</label><input type="number" step="0.1" value="${c.ass||0}" class="veh-ass" data-id="${v.id}"/></div>
            <div><label>Connect / mois</label><input type="number" step="0.1" value="${c.conn||0}" class="veh-conn" data-id="${v.id}"/></div>
            <div><label>Entretien / mois</label><input type="number" step="0.1" value="${c.ent||0}" class="veh-ent" data-id="${v.id}"/></div>
            <div><label>Amort. (auto) / mois</label><input type="number" value="${amort.toFixed(2)}" disabled/></div>
          </div>
          <div class="grid-3 mt-3">
            <div><label>Total investi (‚Ç¨)</label><input type="number" step="0.1" value="${c.totalInvested||0}" class="veh-total" data-id="${v.id}"/></div>
            <div><label>Valeur r√©siduelle estim√©e (‚Ç¨)</label><input type="number" step="0.1" value="${c.residual||0}" class="veh-resid" data-id="${v.id}"/></div>
            <div><label>Dur√©e amort. (mois)</label><input type="number" value="${c.amortMonths||60}" class="veh-months" data-id="${v.id}"/></div>
          </div>
          <div class="grid-3 mt-2">
            <div><label>Base amortissable</label><input type="text" value="${Math.max(0,(c.totalInvested||0)-(c.residual||0)).toFixed(2)} ‚Ç¨" disabled/></div>
            <div><label>Formule</label><input type="text" value="(Total ‚Äì R√©siduelle) √∑ Mois" disabled/></div>
            <div><label>R√©sultat</label><input type="text" value="${amort.toFixed(2)} ‚Ç¨/mois" disabled/></div>
          </div>
          <div class="mt-3 flex gap-2">
            <button class="btn" onclick="saveVehicles()">üíæ Sauvegarder</button>
            <button class="btn-ghost" onclick="removeVehicle('${v.id}')">Supprimer</button>
          </div>`;
        wrap.appendChild(card);
      });

      // Wire inputs
      wrap.querySelectorAll('.veh-name').forEach(i=> i.oninput = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.name=e.target.value; saveAll(); renderVehiclesUI(); }});
      wrap.querySelectorAll('.veh-active').forEach(i=> i.onchange = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.active=e.target.checked; saveAll(); renderVehiclesUI(); }});
      wrap.querySelectorAll('.veh-ass').forEach(i=> i.oninput = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.costs.ass=Number(e.target.value||0); saveAll(); }});
      wrap.querySelectorAll('.veh-conn').forEach(i=> i.oninput = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.costs.conn=Number(e.target.value||0); saveAll(); }});
      wrap.querySelectorAll('.veh-ent').forEach(i=> i.oninput = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.costs.ent=Number(e.target.value||0); saveAll(); }});
      wrap.querySelectorAll('.veh-total').forEach(i=> i.oninput = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.costs.totalInvested=Number(e.target.value||0); saveAll(); renderVehiclesUI(); }});
      wrap.querySelectorAll('.veh-resid').forEach(i=> i.oninput = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.costs.residual=Number(e.target.value||0); saveAll(); renderVehiclesUI(); }});
      wrap.querySelectorAll('.veh-months').forEach(i=> i.oninput = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.costs.amortMonths=Math.max(1,Number(e.target.value||1)); saveAll(); renderVehiclesUI(); }});
    }
    function addVehicle(){
      const id='veh_'+Math.random().toString(36).slice(2,8);
      vehicles.push({ id, name:'Nouveau v√©hicule', active:true, costs:{ass:0,conn:0,ent:0,totalInvested:0,residual:0,amortMonths:60} });
      saveAll(); renderVehiclesUI(); renderTable(); renderCharts(); fillSimDefaults();
    }
    function removeVehicle(id){
      if(!confirm('Supprimer ce v√©hicule ?')) return;
      vehicles = vehicles.filter(v=> v.id!==id);
      locations = locations.filter(l=> l.vehiculeId!==id);
      saveAll(); renderVehiclesUI(); renderTable(); renderCharts(); fillSimDefaults();
    }
    function saveVehicles(){ saveAll(); alert('V√©hicules sauvegard√©s ‚úÖ'); fillSimDefaults(); }

    // ===== Globals =====
    function loadGlobals(){ $('commission').value=globals.commission; $('wearPerKm').value=globals.wearPerKm; $('kmInclus').value=globals.kmInclus; }
    function saveGlobals(){
      globals.commission=Number($('commission').value||0);
      globals.wearPerKm=Number($('wearPerKm').value||0);
      globals.kmInclus=Number($('kmInclus').value||0);
      saveAll(); $('savedTag').style.display='inline'; setTimeout(()=>{$('savedTag').style.display='none'},1200);
    }

    // ===== Tabs =====
    function showTab(id){
      document.querySelectorAll('section.card').forEach(s=> s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if(id==='suivi') renderCharts();
      if(id==='previsions') fillSimDefaults();
    }

    // ===== Locations =====
    function saveLocation(){
      const date=$('date').value; if(!date) return alert('Choisis une date');
      const obj={ date,
        jours:Number($('jours').value||1), prixJour:Number($('prixJour').value||0),
        kms:$('kms').value?Number($('kms').value):0, extras:Number($('extras').value||0),
        fuelAdj:Number($('fuelAdj').value||0), notes:$('notes').value||'',
        vehiculeId:$('vehicule').value
      };
      if(editId){ locations=locations.map(l=> l.id===editId? {...l,...obj}:l); editId=null; $('cancelEditBtn').classList.add('hidden'); $('saveBtn').textContent='Enregistrer'; }
      else { const id=crypto.randomUUID?crypto.randomUUID():String(Date.now()); locations.push({id,...obj}); }
      saveAll(); clearLocForm(); renderTable(); renderCharts();
    }
    function cancelEdit(){ editId=null; clearLocForm(); $('cancelEditBtn').classList.add('hidden'); $('saveBtn').textContent='Enregistrer'; }
    function clearLocForm(){ $('date').value=''; $('jours').value=1; $('prixJour').value=30; $('kms').value=''; $('extras').value='0'; $('fuelAdj').value='0'; $('notes').value=''; }
    function removeLoc(id){ locations=locations.filter(l=> l.id!==id); saveAll(); renderTable(); renderCharts(); }
    function editLoc(id){
      const l=locations.find(x=>x.id===id); if(!l) return;
      editId=id; $('date').value=l.date||''; $('jours').value=l.jours??1; $('prixJour').value=l.prixJour??0; $('kms').value=l.kms??''; $('extras').value=l.extras??0; $('fuelAdj').value=l.fuelAdj??0; $('notes').value=l.notes||'';
      $('vehicule').value=l.vehiculeId; $('cancelEditBtn').classList.remove('hidden'); $('saveBtn').textContent='Mettre √† jour'; window.scrollTo({top:0,behavior:'smooth'});
    }

    function netLocation(l){
      const com=(globals.commission||0)/100;
      const after=(l.prixJour*(l.jours||1))*(1-com);
      const wear=(l.kms||0)*(globals.wearPerKm||0);
      return after - wear - (l.extras||0) + (l.fuelAdj||0);
    }

    // Table Locations + filtres
    function fillFilters(){
      const filt=$('filterVehicule'); filt.innerHTML='';
      const optAll=document.createElement('option'); optAll.value='ALL'; optAll.textContent='Tous v√©hicules'; filt.appendChild(optAll);
      vehicles.filter(v=>v.active).forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=v.name; filt.appendChild(o); });
    }
    function fillVehSelect(){
      const sel=$('vehicule'); sel.innerHTML='';
      vehicles.filter(v=>v.active).forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=v.name; sel.appendChild(o); });
    }
    function renderTable(){
      const tbody=$('locTable'); tbody.innerHTML='';
      const m=$('filterMonth').value; const vf=$('filterVehicule').value||'ALL';
      const arr=locations.slice().sort((a,b)=> new Date(b.date)-new Date(a.date)).filter(l=> (!m||monthKey(l.date)===m) && (vf==='ALL'||l.vehiculeId===vf));
      for(const l of arr){
        const v=vehicleById(l.vehiculeId); const net=netLocation(l);
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${l.date}</td><td>${l.jours||1}</td>
          <td>${(Number(l.prixJour)||0).toFixed(2)}</td>
          <td>${l.kms||'-'}</td>
          <td>${(l.extras||0).toFixed(2)}</td>
          <td>${(l.fuelAdj||0).toFixed(2)}</td>
          <td>${v? v.name : '‚Äî'}</td>
          <td><span class="pill" style="background:${net>=0?'rgba(22,163,74,.18)':'rgba(239,68,68,.18)'};color:${net>=0?'#16a34a':'#ef4444'}">${net.toFixed(2)}‚Ç¨</span></td>
          <td title="${(l.notes||'').replace(/"/g,'&quot;')}" style="max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${l.notes||''}</td>
          <td class="whitespace-nowrap">
            <button class="btn-ghost" onclick="editLoc('${l.id}')">‚úèÔ∏è</button>
            <button class="btn-ghost" onclick="removeLoc('${l.id}')">üóëÔ∏è</button>
          </td>`;
        tbody.appendChild(tr);
      }
    }
    $('filterMonth').addEventListener('change', renderTable);
    $('filterVehicule').addEventListener('change', renderTable);

    // ===== Pr√©visions =====
    let simChart;
    function fillSimDefaults(){
      const sel=$('simVehicule'); sel.innerHTML='';
      vehicles.filter(v=>v.active).forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=v.name; sel.appendChild(o); });
      $('simCommission').value=globals.commission; $('simWear').value=globals.wearPerKm;
      if(!sel.value && vehicles.filter(v=>v.active)[0]) sel.value=vehicles.filter(v=>v.active)[0].id;
    }
    function runSim(){
      const vehId=$('simVehicule').value; const veh=vehicleById(vehId); if(!veh) return alert('Ajoute un v√©hicule actif.');
      const days=Number($('simDays').value||0), price=Number($('simPrice').value||0), kmday=Number($('simKmDay').value||0);
      const commission=Number($('simCommission').value||globals.commission), wearPerKm=Number($('simWear').value||globals.wearPerKm), seasonBase=Number($('simSeasonBase').value||100)/100;
      const com=commission/100, fixed=fixedCostsMonthly(veh);
      const seasonCurve=[0.85,0.80,0.90,1.00,1.05,1.15,1.25,1.20,1.00,0.95,0.85,0.90];
      const shownPrice = price/(1-com);
      const monthlyGross=price*days, after=monthlyGross*(1-com), wear=(kmday*days)*wearPerKm;

      $('simSummary').innerHTML=`
        <div class="card"><div class="text-sm" style="color:var(--muted)">Prix proprio / Prix affich√© estim√©</div><div class="text-xl font-extrabold">${euro(price)} / ${euro(shownPrice)}</div></div>
        <div class="card"><div class="text-sm" style="color:var(--muted)">Apr√®s com ‚Äì Usure</div><div class="text-xl font-extrabold">${euro(after)} ‚Äì ${euro(wear)}</div></div>
        <div class="card"><div class="text-sm" style="color:var(--muted)">Fixes mensuels (${veh.name})</div><div class="text-xl font-extrabold">-${euro(fixed)}</div><div class="text-xs" style="color:var(--muted)">(incl. amort. bas√© sur Total ‚Äì R√©siduelle)</div></div>
      `;

      const tbody=$('simTable'); tbody.innerHTML='';
      const labels=['01','02','03','04','05','06','07','08','09','10','11','12']; const data=[];
      labels.forEach((m,i)=>{
        const factor=seasonCurve[i]*seasonBase;
        const g=monthlyGross*factor, a=g*(1-com), w=(kmday*days)*wearPerKm*factor, n=a-w-fixed;
        data.push(n);
        const tr=document.createElement('tr'); tr.innerHTML=`<td>${m}</td><td>${euro(g)}</td><td>${euro(a)}</td><td>${euro(w)}</td><td>${euro(fixed)}</td><td><b>${euro(n)}</b></td>`; tbody.appendChild(tr);
      });

      if(simChart) simChart.destroy();
      simChart=new Chart(document.getElementById('simChart').getContext('2d'), {
        type:'bar',
        data:{ labels, datasets:[{ label:`Net mensuel ‚Äì ${veh.name}`, data, backgroundColor:data.map(v=> v>=0?'rgba(79,70,229,.9)':'rgba(239,68,68,.9)') }]},
        options:{ plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true}} }
      });

      // What-if
      const wi=[{lbl:'+2j', d:days+2,p:price},{lbl:'-2j',d:Math.max(0,days-2),p:price},{lbl:'+5‚Ç¨',d:days,p:price+5},{lbl:'-5‚Ç¨',d:days,p:Math.max(0,price-5)},{lbl:'+2j & +5‚Ç¨',d:days+2,p:price+5}];
      const wrap=$('simWhatIf'); wrap.innerHTML='';
      wi.forEach(s=>{
        const g=s.p*s.d,a=g*(1-com),w=(kmday*s.d)*wearPerKm,n=a-w-fixed;
        const c=document.createElement('div'); c.className='card';
        c.innerHTML=`<div class="text-sm" style="color:var(--muted)">${s.lbl}</div><div class="text-lg font-extrabold">${euro(n)}</div><div class="text-xs" style="color:var(--muted)">CA ${euro(g)} ¬∑ Apr√®s com ${euro(a)} ¬∑ Usure ${euro(w)}</div>`;
        wrap.appendChild(c);
      });
    }

    // ===== Suivi =====
    let chartNet, chartCumul;
    function renderCharts(){
      const sel=$('suiviVehicule'); sel.innerHTML=''; const optAll=document.createElement('option'); optAll.value='ALL'; optAll.textContent='Tous v√©hicules'; sel.appendChild(optAll);
      vehicles.filter(v=>v.active).forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=v.name; sel.appendChild(o); }); if(!sel.value) sel.value='ALL';

      const vehF=sel.value, mSel=$('suiviMonth').value;
      const filtered=locations.filter(l=> (vehF==='ALL'||l.vehiculeId===vehF) && (!mSel||monthKey(l.date)===mSel));
      const monthsMap={}; for(const l of filtered){ const mk=monthKey(l.date); (monthsMap[mk]=monthsMap[mk]||[]).push(l); }
      const months=Object.keys(monthsMap).sort();
      const monthlyBefore=months.map(m=> monthsMap[m].reduce((s,l)=> s+netLocation(l),0));
      const monthlyFix=months.map(_=> (vehF==='ALL' ? vehicles.filter(v=>v.active).reduce((s,v)=> s+fixedCostsMonthly(v),0) : fixedCostsMonthly(vehicleById(vehF))));
      const monthlyAfter=monthlyBefore.map((v,i)=> v-monthlyFix[i]);

      const currentM=$('suiviMonth').value || months[months.length-1];
      const top=$('monthTop'), bd=$('monthBreakdown');
      if(currentM){
        const list=monthsMap[currentM]||[]; const before=list.reduce((s,l)=> s+netLocation(l),0);
        const fixSel=(vehF==='ALL' ? vehicles.filter(v=>v.active).reduce((s,v)=> s+fixedCostsMonthly(v),0) : fixedCostsMonthly(vehicleById(vehF)));
        const after=before-fixSel;
        top.innerHTML=`${currentM} ¬∑ Net (avant fixes): <b>${euro(before)}</b> ¬∑ Fixes: <b>-${euro(fixSel)}</b> ¬∑ R√©sultat net: <b style="color:${after>=0?'var(--pos)':'var(--neg)'}">${euro(after)}</b>`;
        bd.innerHTML='';
        (vehF==='ALL'?vehicles.filter(v=>v.active):[vehicleById(vehF)]).forEach(v=>{
          const b=fixedCostsBreakdown(v);
          const card=document.createElement('div'); card.className='card';
          card.innerHTML=`<div class="text-sm" style="color:var(--muted)">${v.name} ‚Äì D√©tail fixes</div>
          <div class="grid-3 mt-2">
            <div><div class="text-xs" style="color:var(--muted)">Assurance</div><div class="text-lg font-bold">${euro(b.ass)}</div></div>
            <div><div class="text-xs" style="color:var(--muted)">Connect</div><div class="text-lg font-bold">${euro(b.conn)}</div></div>
            <div><div class="text-xs" style="color:var(--muted)">Entretien</div><div class="text-lg font-bold">${euro(b.ent)}</div></div>
            <div><div class="text-xs" style="color:var(--muted)">Amort. (Total ‚Äì R√©siduelle) √∑ ${b.months}</div><div class="text-lg font-bold">${euro(b.amort)}</div></div>
          </div>`;
          bd.appendChild(card);
        });
      }else{ top.textContent='Aucune donn√©e'; bd.innerHTML=''; }

      if(chartNet) chartNet.destroy(); if(chartCumul) chartCumul.destroy();
      chartNet=new Chart(document.getElementById('chartNet').getContext('2d'), { type:'bar',
        data:{ labels:months, datasets:[{ label:'Net apr√®s frais fixes (‚Ç¨)', data:monthlyAfter, backgroundColor:monthlyAfter.map(v=> v>=0?'rgba(79,70,229,.9)':'rgba(239,68,68,.9)') }]},
        options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
      const cum=[]; let acc=0; for(const v of monthlyAfter){ acc+=v; cum.push(acc); }
      chartCumul=new Chart(document.getElementById('chartCumul').getContext('2d'), { type:'line',
        data:{ labels:months, datasets:[{ label:'Cumul annuel (‚Ç¨)', data:cum, fill:false, borderColor:'rgba(79,70,229,.95)', tension:.25, pointRadius:3 }]},
        options:{ plugins:{legend:{display:false}} }
      });
    }
    $('suiviVehicule')?.addEventListener('change', renderCharts);
    $('suiviMonth')?.addEventListener('change', renderCharts);

    // ===== Export / Import =====
    $('exportJson').addEventListener('click', ()=>{
      const blob=new Blob([JSON.stringify({theme: themeToggle.checked?'light':'dark', vehicles, globals, locations}, null, 2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`roi-data-${new Date().toISOString().slice(0,10)}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),0);
    });
    $('importJson').addEventListener('change', e=>{
      const f=e.target.files?.[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{ try{
        const d=JSON.parse(r.result);
        if(d.theme){ themeToggle.checked=(d.theme==='light'); applyTheme(); }
        if(Array.isArray(d.vehicles)) vehicles=d.vehicles.map(v=> ({...v, costs:{...v.costs, residual: v.costs?.residual ?? 0}}));
        if(d.globals) globals=d.globals;
        if(Array.isArray(d.locations)) locations=d.locations;
        saveAll(); renderVehiclesUI(); fillVehSelect(); fillFilters(); renderTable(); renderCharts(); fillSimDefaults(); alert('Import r√©ussi ‚úÖ');
      }catch(_){ alert('Fichier invalide ‚ùå'); } }; r.readAsText(f);
    });
    $('exportCsv').addEventListener('click', ()=>{
      const rows=[['id','date','jours','prixJour','kms','extras','fuelAdj','vehicule','net','notes']];
      locations.forEach(l=> rows.push([l.id,l.date,l.jours,l.prixJour,l.kms,l.extras,l.fuelAdj||0,(vehicleById(l.vehiculeId)?.name||''),netLocation(l).toFixed(2),(l.notes||'').replace(/"/g,'""')]));
      const csv=rows.map(r=> r.map(x=>`"${String(x)}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='locations.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),0);
    });

    // ===== Init =====
    function init(){
      // Ensure Clio & Tesla exist once
      if(!vehicles.find(v=>v.id==='clio')) vehicles.push({ id:'clio', name:'Clio', active:true, costs:{ass:56,conn:25,ent:45,totalInvested:11659,residual:0,amortMonths:60} });
      if(!vehicles.find(v=>v.id==='tesla')) vehicles.push({ id:'tesla', name:'Tesla', active:true, costs:{ass:115,conn:0,ent:30,totalInvested:0,residual:0,amortMonths:60} });

      renderVehiclesUI(); fillVehSelect(); fillFilters(); loadGlobals(); renderTable(); renderCharts(); fillSimDefaults();
      showTab('vehicles');
    }
    init();
  </script>
</body>
</html>
