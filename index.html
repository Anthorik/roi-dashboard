<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ROI - Flotte Auto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      /* Graphite premium */
      --bg1:#0b0d10; --bg2:#111418; --card:rgba(22,26,32,.72); --text:#e7e9ee; --muted:#a4acb9;
      --border:rgba(255,255,255,.08); --ring:#7dd3fc;
      --primary:#7c3aed; --primary-d:#6d28d9;
      --pos:#16a34a; --neg:#ef4444;
      --shadow:0 10px 40px rgba(0,0,0,.35);
    }
    .light{
      --bg1:#f7f8fb; --bg2:#eef1f6; --card:rgba(255,255,255,.85); --text:#0f172a; --muted:#5b6576;
      --border:rgba(15,23,42,.12); --ring:#0ea5e9;
      --primary:#4f46e5; --primary-d:#4338ca;
      --pos:#16a34a; --neg:#ef4444;
      --shadow:0 10px 30px rgba(2,6,23,.08);
    }

    /* Background with subtle gradients */
    body{
      min-height:100vh;
      background:
        radial-gradient(1000px 600px at 15% -10%, rgba(124,58,237,.12), transparent 60%),
        radial-gradient(900px 560px at 100% 10%, rgba(14,165,233,.10), transparent 55%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--text);
      font-synthesis-weight: none;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:1.2rem;
      padding:1.25rem;
      box-shadow:var(--shadow);
      backdrop-filter: blur(8px);
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .card:hover{ transform:translateY(-2px); box-shadow:0 16px 48px rgba(0,0,0,.35); border-color:rgba(124,58,237,.25); }

    .btn{
      background:linear-gradient(180deg,var(--primary),var(--primary-d));
      color:#fff; padding:.6rem 1rem; border-radius:.8rem; font-weight:700;
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 6px 20px rgba(124,58,237,.35);
      transition:transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .btn:hover{ transform:translateY(-1px); filter:brightness(1.04); }
    .btn:active{ transform:translateY(0); box-shadow:none; }
    .btn-ghost{
      background:transparent; color:var(--text);
      padding:.55rem .9rem; border-radius:.8rem; border:1px solid var(--border);
      transition: background .12s ease, border-color .12s ease;
    }
    .btn-ghost:hover{ background:rgba(255,255,255,.05); border-color:rgba(255,255,255,.16); }

    input, select{
      background:rgba(255,255,255,.03);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:.7rem;
      padding:.6rem .7rem; width:100%;
      outline: none;
      transition:border-color .12s ease, box-shadow .12s ease, background .12s ease;
    }
    input:focus, select:focus{
      border-color:var(--ring);
      box-shadow:0 0 0 4px rgba(125,211,252,.18);
      background:rgba(255,255,255,.06);
    }
    label{ color:var(--muted); font-size:.9rem; }

    table{ width:100%; border-collapse:collapse; }
    th,td{ border-bottom:1px solid var(--border); padding:.6rem .65rem; }
    th{ color:var(--muted); text-align:left; font-weight:600; letter-spacing:.01em; }

    .pill{
      font-size:.75rem; font-weight:800; padding:.25rem .6rem; border-radius:999px;
    }

    .toggle{ display:flex; align-items:center; gap:.6rem; cursor:pointer; user-select:none; }
    .toggle input{
      width:2.75rem; height:1.45rem; appearance:none;
      background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));
      border:1px solid var(--border); border-radius:999px; position:relative; outline:none;
      transition: all .18s ease;
    }
    .toggle input:checked{ background:linear-gradient(180deg,var(--primary),var(--primary-d)); }
    .toggle input:before{
      content:""; position:absolute; top:2px; left:2px; width:1.15rem; height:1.15rem; background:#fff; border-radius:999px;
      box-shadow:0 3px 12px rgba(0,0,0,.25);
      transition: all .18s ease;
    }
    .toggle input:checked:before{ transform:translateX(1.25rem); }

    .grid-2{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; }
    .grid-3{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; }
    .grid-4{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; }
    @media(min-width:768px){
      .grid-2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
      .grid-3{ grid-template-columns:repeat(3,minmax(0,1fr)); }
      .grid-4{ grid-template-columns:repeat(4,minmax(0,1fr)); }
    }
    .kbd{ font-size:.75rem; padding:.15rem .35rem; border-radius:.4rem; border:1px solid var(--border); color:var(--muted); }

    .fade-in{ animation:fade .25s ease both; }
    @keyframes fade{ from{opacity:0; transform:translateY(4px);} to{opacity:1; transform:translateY(0);} }
  </style>
</head>
<body>
  <header class="mb-6 max-w-7xl mx-auto px-4">
    <div class="flex items-center justify-between gap-4">
      <h1 class="text-2xl font-extrabold tracking-tight">üìä Dashboard ROI ‚Äì Flotte Auto</h1>
      <div class="flex flex-wrap items-center gap-2">
        <label class="toggle" title="Basculer th√®me clair/sombre">
          <span style="color:var(--muted)">Th√®me clair</span><input type="checkbox" id="themeToggle"/>
        </label>
        <label class="toggle" title="Activer/D√©sactiver Tesla">
          <span style="color:var(--muted)">Tesla</span><input type="checkbox" id="teslaToggle"/>
        </label>
        <button id="exportJson" class="btn-ghost">Export JSON</button>
        <label class="btn-ghost cursor-pointer">Import JSON<input id="importJson" type="file" accept="application/json" class="hidden"/></label>
        <button id="exportCsv" class="btn-ghost">Export CSV</button>
      </div>
    </div>

    <div class="mt-4 flex flex-wrap gap-2">
      <button class="btn" onclick="showTab('locations')">Locations r√©elles</button>
      <button class="btn" onclick="showTab('params')">Param√®tres</button>
      <button class="btn" onclick="showTab('previsions')">Pr√©visions & Tarifs</button>
      <button class="btn" onclick="showTab('suivi')">Suivi mensuel</button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 space-y-6">
    <!-- LOCATIONS -->
    <section id="locations" class="card hidden fade-in">
      <h2 class="text-xl font-semibold mb-3">üìÖ Locations r√©elles</h2>
      <div class="grid-4">
        <div><label>D√©but</label><input type="date" id="date"/></div>
        <div><label>Jours</label><input type="number" id="jours" min="1" value="1"/></div>
        <div><label>Prix proprio ‚Ç¨/jour</label><input type="number" id="prixJour" min="0" step="0.1" value="30"/></div>
        <div id="vehiculeWrap" class="hidden"><label>V√©hicule</label><select id="vehicule"><option value="Clio">Clio</option><option value="Tesla">Tesla</option></select></div>
        <div><label>Km totaux (optionnel)</label><input type="number" id="kms" min="0" step="1" placeholder="ex. 250"/></div>
        <div><label>Frais divers (‚Ç¨)</label><input type="number" id="extras" min="0" step="0.1" value="0"/></div>
        <div><label>Ajustement carburant (+/‚àí ‚Ç¨)</label><input type="number" id="fuelAdj" step="0.1" value="0"/></div>
        <div class="md:col-span-2"><label>Notes</label><input type="text" id="notes" placeholder="Ex. week-end, pro, remise‚Ä¶"/></div>
      </div>

      <div class="mt-3 flex flex-wrap gap-2">
        <button id="saveBtn" class="btn" onclick="saveLocation()">Enregistrer</button>
        <button id="cancelEditBtn" class="btn-ghost hidden" onclick="cancelEdit()">Annuler</button>
        <select id="filterVehicule" class="w-auto"><option value="ALL">Tous v√©hicules</option><option value="Clio">Clio</option><option value="Tesla">Tesla</option></select>
        <input type="month" id="filterMonth" class="w-auto"/><button class="btn-ghost" onclick="clearFilters()">Effacer filtres</button>
        <span class="ml-auto text-xs" style="color:var(--muted)">Astuce : double-clique une ligne pour l‚Äô√©diter <span class="kbd">‚èé</span></span>
      </div>

      <div class="mt-4 overflow-x-auto">
        <table>
          <thead><tr><th>Date</th><th>Jours</th><th>‚Ç¨/j</th><th>Km</th><th>Frais</th><th>Carburant ¬±</th><th>V√©hicule</th><th>Net loc</th><th>Notes</th><th>Actions</th></tr></thead>
          <tbody id="locTable"></tbody>
        </table>
      </div>
      <p class="text-sm mt-2" style="color:var(--muted)">Net location = (prix √ó jours √ó (1‚Äìcommission)) ‚àí usure(km√ó‚Ç¨/km) ‚àí frais divers + ajustement carburant.</p>
    </section>

    <!-- PARAMETRES -->
    <section id="params" class="card hidden fade-in">
      <h2 class="text-xl font-semibold mb-3">‚öôÔ∏è Param√®tres</h2>
      <div class="grid-3">
        <div><label>Commission plateforme (%)</label><input type="number" id="commission" min="0" step="0.1" value="10"/></div>
        <div><label>Usure ‚Ç¨/km</label><input type="number" id="wearPerKm" min="0" step="0.01" value="0.12"/></div>
        <div><label>Km inclus / jour</label><input type="number" id="kmInclus" min="0" step="1" value="100"/></div>
      </div>

      <div class="mt-4 grid-2">
        <div class="card">
          <h3 class="font-semibold mb-2">Clio ‚Äì frais fixes / mois</h3>
          <div class="grid-4">
            <div><label>Assurance</label><input type="number" id="clioAss" value="54"/></div>
            <div><label>Connect</label><input type="number" id="clioConn" value="25"/></div>
            <div><label>Entretien</label><input type="number" id="clioEnt" value="45"/></div>
            <div><label>Amort. v√©hicule</label><input type="number" id="clioAmort" value="181"/></div>
          </div>
          <div class="mt-3 grid-3">
            <div><label>Frais acquisition (total ‚Ç¨)</label><input type="number" id="clioAcqTotal" value="0"/></div>
            <div><label>Dur√©e amort. acquisition (mois)</label><input type="number" id="clioAcqMonths" value="60"/></div>
            <div><label>Amort. acquisition (auto)</label><input type="number" id="clioAcqAmort" value="0" disabled/></div>
          </div>
        </div>

        <div class="card" id="teslaParamsCard" style="display:none;">
          <h3 class="font-semibold mb-2">Tesla ‚Äì frais fixes / mois</h3>
          <div class="grid-4">
            <div><label>Assurance</label><input type="number" id="teslaAss" value="115"/></div>
            <div><label>Connect</label><input type="number" id="teslaConn" value="0"/></div>
            <div><label>Entretien</label><input type="number" id="teslaEnt" value="30"/></div>
            <div><label>Amort. v√©hicule</label><input type="number" id="teslaAmort" value="0"/></div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <button class="btn" onclick="saveParams()">üíæ Sauvegarder</button>
        <span id="savedTag" class="ml-3 text-sm" style="color:var(--muted); display:none;">‚úîÔ∏è Sauvegard√©</span>
      </div>
    </section>

    <!-- PREVISIONS -->
    <section id="previsions" class="card hidden fade-in">
      <h2 class="text-xl font-semibold mb-3">üìà Pr√©visions & Tarifs</h2>
      <div class="grid-4">
        <div><label>Jours lou√©s / mois</label><input type="number" id="simDays" value="12"/></div>
        <div><label>Prix proprio ‚Ç¨/j</label><input type="number" id="simPrice" value="30" step="0.1"/></div>
        <div><label>Km/j (moy.)</label><input type="number" id="simKmDay" value="100"/></div>
        <div><label>Saisonnalit√© (%)</label><input type="number" id="simSeason" value="100"/></div>
      </div>
      <div class="mt-3 flex gap-2">
        <select id="simVehicule" class="w-auto"><option value="Clio">Clio</option><option value="Tesla">Tesla</option></select>
        <button class="btn" onclick="runSim()">Calculer</button>
      </div>
      <div id="simOut" class="mt-4"></div>

      <div class="mt-6">
        <h3 class="font-semibold mb-2">Pr√©visions 12 mois (saisonnalit√© simple)</h3>
        <canvas id="simChart" height="140"></canvas>
      </div>
    </section>

    <!-- SUIVI -->
    <section id="suivi" class="card hidden fade-in">
      <h2 class="text-xl font-semibold mb-3">üìä Suivi mensuel</h2>
      <div class="flex flex-wrap items-center gap-2 mb-3">
        <select id="suiviVehicule" class="w-auto"><option value="ALL">Tous v√©hicules</option><option value="Clio">Clio</option><option value="Tesla">Tesla</option></select>
        <input type="month" id="suiviMonth" class="w-auto" />
      </div>
      <div class="grid-2">
        <div><canvas id="chartNet" height="150"></canvas></div>
        <div><canvas id="chartCumul" height="150"></canvas></div>
      </div>
      <div id="monthTop" class="mt-3 text-sm"></div>
      <div id="monthBreakdown" class="mt-2 grid-2"></div>
    </section>
  </main>

  <script>
    // ===== State & Storage =====
    const KEY='roi_graphite_v1';
    const data = JSON.parse(localStorage.getItem(KEY) || '{}');
    const theme = data.theme || 'dark';
    let teslaOn = data.teslaOn ?? false;
    let settings = data.settings || {
      commission:10, wearPerKm:0.12, kmInclus:100,
      clio:{ass:54, conn:25, ent:45, amort:181, acqTotal:0, acqMonths:60},
      tesla:{ass:115, conn:0, ent:30, amort:0}
    };
    let locations = data.locations || []; // {id,date,jours,prixJour,kms,extras,fuelAdj,notes,vehicule}
    let editId = null;

    // ===== Theme =====
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(){ themeToggle.checked ? document.documentElement.classList.add('light') : document.documentElement.classList.remove('light'); }
    themeToggle.checked = (theme==='light'); applyTheme();
    themeToggle.addEventListener('change', ()=>{ data.theme = themeToggle.checked?'light':'dark'; saveAll(); applyTheme(); });

    // ===== Tesla toggle & UI =====
    const teslaToggle = document.getElementById('teslaToggle'); teslaToggle.checked = !!teslaOn;
    function applyTeslaUI(){
      document.getElementById('vehiculeWrap').style.display = teslaToggle.checked ? 'block' : 'none';
      document.getElementById('teslaParamsCard').style.display = teslaToggle.checked ? 'block' : 'none';
      document.getElementById('simVehicule').style.display = teslaToggle.checked ? 'inline-block' : 'none';
      document.querySelectorAll('#filterVehicule, #suiviVehicule').forEach(sel=>{
        sel.querySelectorAll('option[value="Tesla"]').forEach(o=> o.disabled = !teslaToggle.checked);
      });
    }
    applyTeslaUI();
    teslaToggle.addEventListener('change', ()=>{ teslaOn = teslaToggle.checked; data.teslaOn=teslaOn; saveAll(); applyTeslaUI(); renderTable(); renderCharts(); });

    // ===== Tabs =====
    function showTab(id){
      document.querySelectorAll('section.card').forEach(s=> s.classList.add('hidden'));
      const el = document.getElementById(id);
      el.classList.remove('hidden');
      if(id==='suivi'){ renderCharts(); }
    }
    showTab('locations');

    // ===== Helpers =====
    const $ = id => document.getElementById(id);
    const euro = n => `${(n||0).toFixed(2)}‚Ç¨`;
    const monthKey = d => d?.slice(0,7);
    function saveAll(){ localStorage.setItem(KEY, JSON.stringify({theme: themeToggle.checked?'light':'dark', teslaOn, settings, locations})); }
    function setEditMode(on){ $('saveBtn').textContent = on ? 'Mettre √† jour' : 'Enregistrer'; $('cancelEditBtn').classList.toggle('hidden', !on); }
    function toastSaved(){
      const tag=document.getElementById('savedTag'); if(!tag) return;
      tag.style.display='inline'; setTimeout(()=>tag.style.display='none',1200);
    }

    // ===== Locations CRUD =====
    function saveLocation(){
      const date = $('date').value; if(!date) return alert('Choisis une date');
      const obj = {
        date, jours:Number($('jours').value||1), prixJour:Number($('prixJour').value||0),
        kms:$('kms').value?Number($('kms').value):0, extras:Number($('extras').value||0),
        fuelAdj:Number($('fuelAdj').value||0), notes:$('notes').value||'',
        vehicule: teslaToggle.checked ? $('vehicule').value : 'Clio'
      };
      if(editId){ locations = locations.map(l=> l.id===editId ? {...l, ...obj} : l); editId=null; setEditMode(false); }
      else { const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()); locations.push({id, ...obj}); }
      saveAll(); clearLocForm(); renderTable(); renderCharts();
    }
    function cancelEdit(){ editId=null; clearLocForm(); setEditMode(false); }
    function clearLocForm(){ $('date').value=''; $('jours').value=1; $('prixJour').value=30; $('kms').value=''; $('extras').value='0'; $('fuelAdj').value='0'; $('notes').value=''; if(teslaToggle.checked) $('vehicule').value='Clio'; }
    function removeLoc(id){ locations = locations.filter(l=> l.id!==id); saveAll(); renderTable(); renderCharts(); }
    function editLoc(id){
      const l = locations.find(x=> x.id===id); if(!l) return;
      editId=id; $('date').value=l.date||''; $('jours').value=l.jours??1; $('prixJour').value=l.prixJour??0; $('kms').value=l.kms??''; $('extras').value=l.extras??0; $('fuelAdj').value=l.fuelAdj??0; $('notes').value=l.notes||''; if(teslaToggle.checked && l.vehicule) $('vehicule').value=l.vehicule; setEditMode(true); window.scrollTo({top:0,behavior:'smooth'});
    }
    // dblclick to edit
    function dblEdit(id){ editLoc(id); }

    // ===== Calculs =====
    function netLocation(loc){
      const com=(settings.commission||0)/100;
      const after = (loc.prixJour * (loc.jours||1)) * (1-com);
      const wear  = (loc.kms||0) * (settings.wearPerKm||0);
      return after - wear - (loc.extras||0) + (loc.fuelAdj||0);
    }
    function clioAcqAmortMonthly(){
      const total = Number(settings.clio.acqTotal||0);
      const months = Math.max(1, Number(settings.clio.acqMonths||0));
      return total / months;
    }

    // ===== Table Locations =====
    function clearFilters(){ $('filterMonth').value=''; $('filterVehicule').value='ALL'; renderTable(); }
    function renderTable(){
      const tbody=$('locTable'); tbody.innerHTML='';
      const m=$('filterMonth').value; const vf=$('filterVehicule').value;
      const arr = locations.slice().sort((a,b)=> new Date(b.date)-new Date(a.date)).filter(l=> (!m||monthKey(l.date)===m) && (vf==='ALL'||l.vehicule===vf));
      for(const l of arr){
        const net=netLocation(l);
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${l.date}</td><td>${l.jours||1}</td>
          <td>${(Number(l.prixJour)||0).toFixed(2)}</td>
          <td>${l.kms||'-'}</td>
          <td>${(l.extras||0).toFixed(2)}</td>
          <td>${(l.fuelAdj||0).toFixed(2)}</td>
          <td>${l.vehicule||'Clio'}</td>
          <td><span class="pill" style="background:${net>=0?'rgba(22,163,74,.18)':'rgba(239,68,68,.18)'};color:${net>=0?'#16a34a':'#ef4444'}">${net.toFixed(2)}‚Ç¨</span></td>
          <td title="${(l.notes||'').replace(/"/g,'&quot;')}" style="max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${l.notes||''}</td>
          <td class="whitespace-nowrap">
            <button class="btn-ghost" onclick="editLoc('${l.id}')">‚úèÔ∏è</button>
            <button class="btn-ghost" onclick="removeLoc('${l.id}')">üóëÔ∏è</button>
          </td>`;
        tr.ondblclick = ()=> dblEdit(l.id);
        tbody.appendChild(tr);
      }
    }
    document.getElementById('filterMonth').addEventListener('change', renderTable);
    document.getElementById('filterVehicule').addEventListener('change', renderTable);
    renderTable();

    // ===== Params UI =====
    function loadParamsIntoUI(){
      $('commission').value=settings.commission; $('wearPerKm').value=settings.wearPerKm; $('kmInclus').value=settings.kmInclus;
      $('clioAss').value=settings.clio.ass; $('clioConn').value=settings.clio.conn; $('clioEnt').value=settings.clio.ent; $('clioAmort').value=settings.clio.amort;
      $('clioAcqTotal').value=settings.clio.acqTotal||0; $('clioAcqMonths').value=settings.clio.acqMonths||60;
      $('clioAcqAmort').value=(settings.clio.acqTotal? (Number(settings.clio.acqTotal)/Math.max(1,Number(settings.clio.acqMonths||0))).toFixed(2):0);
      $('teslaAss').value=settings.tesla.ass; $('teslaConn').value=settings.tesla.conn; $('teslaEnt').value=settings.tesla.ent; $('teslaAmort').value=settings.tesla.amort;
    }
    function saveParams(){
      settings.commission=Number($('commission').value||0);
      settings.wearPerKm=Number($('wearPerKm').value||0);
      settings.kmInclus=Number($('kmInclus').value||0);
      settings.clio={ ass:Number($('clioAss').value||0), conn:Number($('clioConn').value||0), ent:Number($('clioEnt').value||0), amort:Number($('clioAmort').value||0),
        acqTotal:Number($('clioAcqTotal').value||0), acqMonths:Number($('clioAcqMonths').value||60) };
      settings.tesla={ ass:Number($('teslaAss').value||0), conn:Number($('teslaConn').value||0), ent:Number($('teslaEnt').value||0), amort:Number($('teslaAmort').value||0) };
      $('clioAcqAmort').value = (settings.clio.acqTotal/Math.max(1,settings.clio.acqMonths)).toFixed(2);
      saveAll(); toastSaved(); renderCharts();
    }
    loadParamsIntoUI();

    // ===== Pr√©visions (incluant amort. acquisition Clio) =====
    let simChart;
    function runSim(){
      const days=Number($('simDays').value||0), price=Number($('simPrice').value||0), kmday=Number($('simKmDay').value||0), season=Number($('simSeason').value||100)/100;
      const veh= teslaToggle.checked ? $('simVehicule').value : 'Clio';
      const com=(settings.commission||0)/100;
      const after=(price*days)*(1-com);
      const wear=(kmday*days)*(settings.wearPerKm||0);
      const fixVeh = (veh==='Tesla' ? (settings.tesla.ass+settings.tesla.conn+settings.tesla.ent+settings.tesla.amort)
                                     : (settings.clio.ass+settings.clio.conn+settings.clio.ent+settings.clio.amort));
      const fixAcq = (veh==='Clio') ? (settings.clio.acqTotal/Math.max(1,settings.clio.acqMonths||1)) : 0;
      const fix = fixVeh + fixAcq;
      const net=(after - wear - fix)*season;

      document.getElementById('simOut').innerHTML = `
        <div class="grid-4">
          <div class="card"><div class="text-sm" style="color:var(--muted)">Net avant fixes</div><div class="text-xl font-extrabold">${euro(after-wear)}</div></div>
          <div class="card"><div class="text-sm" style="color:var(--muted)">Fixes (${veh})</div><div class="text-xl font-extrabold">-${euro(fix)}</div><div class="text-xs" style="color:var(--muted)">${veh==='Clio' ? '(incl. amort. acquisition)' : ''}</div></div>
          <div class="card"><div class="text-sm" style="color:var(--muted)">R√©sultat net (apr√®s saison)</div><div class="text-xl font-extrabold">${euro(net)}</div></div>
          <div class="card"><div class="text-sm" style="color:var(--muted)">Point mort (jours)</div><div class="text-xl font-extrabold">${pointMort(price, kmday, fix)}</div></div>
        </div>`;

      const months=['01','02','03','04','05','06','07','08','09','10','11','12'], seasonCurve=[0.85,0.8,0.9,1.0,1.05,1.15,1.25,1.2,1.0,0.95,0.85,0.9];
      const base=(after - wear - fix); const data=months.map((_,i)=> base*seasonCurve[i]);

      if(simChart){ simChart.destroy(); }
      simChart = new Chart(document.getElementById('simChart').getContext('2d'), {
        type:'bar',
        data:{ labels:months, datasets:[{ label:'Pr√©vision nette mensuelle (‚Ç¨)', data,
          backgroundColor:data.map(v=> v>=0?'rgba(124,58,237,.9)':'rgba(239,68,68,.9)') }]},
        options:{ plugins:{ legend:{display:false}, tooltip:{callbacks:{label:c=>`${c.parsed.y.toFixed(2)} ‚Ç¨`}}}, scales:{ y:{ beginAtZero:true } } }
      });
    }
    function pointMort(price, kmday, fix){
      const com=(settings.commission||0)/100; const netPerDay=price*(1-com) - (kmday*(settings.wearPerKm||0));
      if(netPerDay<=0) return '‚àû'; return (fix/netPerDay).toFixed(1);
    }

    // ===== Suivi & Graphs (incluant amort. acquisition Clio) =====
    let chartNet, chartCumul;
    function renderCharts(){
      const vehF=$('suiviVehicule').value, mSel=$('suiviMonth').value;
      const filtered = locations.filter(l => (vehF==='ALL' || l.vehicule===vehF) && (!mSel || monthKey(l.date)===mSel));

      const monthsMap={}; for(const l of filtered){ const mk=monthKey(l.date); (monthsMap[mk]=monthsMap[mk]||[]).push(l); }
      const months=Object.keys(monthsMap).sort();
      const monthlyBefore=months.map(m=> monthsMap[m].reduce((s,l)=> s+netLocation(l),0));

      const monthlyFix=months.map(m=>{
        const useVeh = (vehF==='ALL' ? ['Clio','Tesla'].filter(v=> teslaOn ? true : v==='Clio') : [vehF]);
        return useVeh.reduce((sum,v)=>{
          const fixesVeh = (v==='Tesla'
            ? (settings.tesla.ass+settings.tesla.conn+settings.tesla.ent+settings.tesla.amort)
            : (settings.clio.ass+settings.clio.conn+settings.clio.ent+settings.clio.amort + (settings.clio.acqTotal/Math.max(1,settings.clio.acqMonths||1))));
          return sum + fixesVeh;
        },0);
      });

      const monthlyAfter = monthlyBefore.map((v,i)=> v - monthlyFix[i]);

      // R√©sum√© + breakdown
      const currentM = $('suiviMonth').value || months[months.length-1];
      const top = document.getElementById('monthTop');
      const bd = document.getElementById('monthBreakdown');
      if(currentM){
        const list = monthsMap[currentM] || [];
        const before = list.reduce((s,l)=> s + netLocation(l), 0);
        const clioAcq = (settings.clio.acqTotal/Math.max(1,settings.clio.acqMonths||1));
        const fixClio = settings.clio.ass+settings.clio.conn+settings.clio.ent+settings.clio.amort + clioAcq;
        const fixTesla= settings.tesla.ass+settings.tesla.conn+settings.tesla.ent+settings.tesla.amort;
        let fix = 0;
        if(vehF==='ALL'){ fix = (teslaOn ? (fixClio+fixTesla) : fixClio); }
        else { fix = (vehF==='Tesla' ? fixTesla : fixClio); }
        const after = before - fix;

        top.innerHTML = `${currentM} ¬∑ Net (avant fixes): <b>${euro(before)}</b> ¬∑ Fixes: <b>-${euro(fix)}</b> ¬∑ R√©sultat net: <b style="color:${after>=0?'#16a34a':'#ef4444'}">${euro(after)}</b>`;

        bd.innerHTML='';
        const addLine=(lbl,val)=>{ const d=document.createElement('div'); d.className='card'; d.innerHTML=`<div class="text-xs" style="color:var(--muted)">${lbl}</div><div class="text-lg font-extrabold">${euro(val)}</div>`; bd.appendChild(d); };

        const showClio = (vehF!=='Tesla');
        const showTesla = teslaOn && (vehF!=='Clio');

        if(showClio){
          addLine('Clio ¬∑ Assurance', settings.clio.ass);
          addLine('Clio ¬∑ Connect', settings.clio.conn);
          addLine('Clio ¬∑ Entretien', settings.clio.ent);
          addLine('Clio ¬∑ Amort. v√©hicule', settings.clio.amort);
          addLine('Clio ¬∑ Amort. acquisition', clioAcq);
        }
        if(showTesla){
          addLine('Tesla ¬∑ Assurance', settings.tesla.ass);
          addLine('Tesla ¬∑ Connect', settings.tesla.conn);
          addLine('Tesla ¬∑ Entretien', settings.tesla.ent);
          addLine('Tesla ¬∑ Amort. v√©hicule', settings.tesla.amort);
        }
      } else {
        top.textContent = 'Aucune donn√©e pour le moment.'; bd.innerHTML='';
      }

      if(chartNet){ chartNet.destroy(); } if(chartCumul){ chartCumul.destroy(); }
      chartNet = new Chart(document.getElementById('chartNet').getContext('2d'), {
        type:'bar',
        data:{ labels:months, datasets:[{ label:'Net apr√®s frais fixes (‚Ç¨)', data:monthlyAfter,
          backgroundColor: monthlyAfter.map(v=> v>=0 ? 'rgba(124,58,237,.9)' : 'rgba(239,68,68,.9)') }]},
        options:{ plugins:{ legend:{display:false}, tooltip:{callbacks:{label:c=>`${c.parsed.y.toFixed(2)} ‚Ç¨`}}}, scales:{ y:{ beginAtZero:true } } }
      });
      const cum=[]; let acc=0; for(const v of monthlyAfter){ acc+=v; cum.push(acc); }
      chartCumul = new Chart(document.getElementById('chartCumul').getContext('2d'), {
        type:'line',
        data:{ labels:months, datasets:[{ label:'Cumul annuel (‚Ç¨)', data:cum, fill:false, borderColor:'rgba(124,58,237,.95)', tension:.25, pointRadius:3 }]},
        options:{ plugins:{ legend:{display:false} } }
      });
    }
    document.getElementById('suiviVehicule').addEventListener('change', renderCharts);
    document.getElementById('suiviMonth').addEventListener('change', renderCharts);

    // ===== Export / Import =====
    document.getElementById('exportJson').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify({theme: themeToggle.checked?'light':'dark', teslaOn, settings, locations}, null, 2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`roi-data-${new Date().toISOString().slice(0,10)}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),0);
    });
    document.getElementById('importJson').addEventListener('change', e=>{
      const f=e.target.files?.[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{ try{
        const d=JSON.parse(r.result);
        if(d.theme){ themeToggle.checked=(d.theme==='light'); applyTheme(); }
        if(typeof d.teslaOn==='boolean'){ teslaOn=d.teslaOn; teslaToggle.checked=teslaOn; }
        if(d.settings) settings=d.settings;
        if(Array.isArray(d.locations)) locations=d.locations;
        saveAll(); loadParamsIntoUI(); applyTeslaUI(); renderTable(); renderCharts(); alert('Import r√©ussi ‚úÖ');
      }catch(_){ alert('Fichier invalide ‚ùå'); } }; r.readAsText(f);
    });
    document.getElementById('exportCsv').addEventListener('click', ()=>{
      const rows=[['id','date','jours','prixJour','kms','extras','fuelAdj','vehicule','net','notes']];
      locations.forEach(l=> rows.push([l.id,l.date,l.jours,l.prixJour,l.kms,l.extras,l.fuelAdj||0,l.vehicule||'Clio',netLocation(l).toFixed(2),(l.notes||'').replace(/"/g,'""')]));
      const csv=rows.map(r=> r.map(x=>`"${String(x)}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='locations.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),0);
    });

    // Init
    function loadParamsIntoUI(){
      document.getElementById('commission').value=settings.commission;
      document.getElementById('wearPerKm').value=settings.wearPerKm;
      document.getElementById('kmInclus').value=settings.kmInclus;
      document.getElementById('clioAss').value=settings.clio.ass;
      document.getElementById('clioConn').value=settings.clio.conn;
      document.getElementById('clioEnt').value=settings.clio.ent;
      document.getElementById('clioAmort').value=settings.clio.amort;
      document.getElementById('clioAcqTotal').value=settings.clio.acqTotal||0;
      document.getElementById('clioAcqMonths').value=settings.clio.acqMonths||60;
      document.getElementById('clioAcqAmort').value=(settings.clio.acqTotal? (Number(settings.clio.acqTotal)/Math.max(1,Number(settings.clio.acqMonths||0))).toFixed(2):0);
      document.getElementById('teslaAss').value=settings.tesla.ass;
      document.getElementById('teslaConn').value=settings.tesla.conn;
      document.getElementById('teslaEnt').value=settings.tesla.ent;
      document.getElementById('teslaAmort').value=settings.tesla.amort;
    }
    loadParamsIntoUI();
    renderCharts();
  </script>
</body>
</html>
